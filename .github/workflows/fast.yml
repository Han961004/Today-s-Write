name: FastAPI CI/CD

on:
  push:
    branches:
      - main
    paths:
      - 'APP_FAST/**'
  pull_request:
    branches:
      - main
    paths:
      - 'APP_FAST/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH keys
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.AWS_LS_SSH_KEY }}

      - name: Deploy FastAPI to AWS Lightsail
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.AWS_LS_IP }} << 'EOF'
          
            set -e  # 오류 발생 시 즉시 종료

            # 1. 기존 apt 프로세스 종료 및 락 파일 삭제
            sudo pkill -9 apt || true
            sudo rm -rf /var/lib/apt/lists/lock /var/lib/dpkg/lock /var/lib/dpkg/lock-frontend

            # 2. Docker 및 Docker Compose 설치
            sudo apt update && sudo apt install -y docker.io curl
            sudo mkdir -p /usr/local/lib/docker/cli-plugins
            sudo curl -SL "https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64" \
                -o /usr/local/lib/docker/cli-plugins/docker-compose
            sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
            docker compose version

            # 3. 프로젝트 디렉토리 설정 (Fast 앱 전용)
            PROJECT_DIR="/home/Today-s-Write"
            sudo mkdir -p $PROJECT_DIR
            sudo chown -R ubuntu:ubuntu $PROJECT_DIR

            # 4. Git 저장소 업데이트
            if [ ! -d $PROJECT_DIR/.git ]; then
                git clone https://github.com/Han961004/Today-s-Write.git $PROJECT_DIR
            else
                cd $PROJECT_DIR
                git fetch origin main
                git reset --hard origin/main
            fi

            # 5. FastAPI 전용 Docker Compose 파일 존재 여부 확인
            cat /home/Today-s-Write/Configurations/nginx/nginx.conf || { echo "❌ nginx.conf 파일이 없습니다. 배포 중지."; exit 1; }

            # 6. 기존 컨테이너 정리 및 재시작 (FastAPI 앱용 docker-compose 파일 사용)
            cd $PROJECT_DIR
            sudo docker compose -f /home/Today-s-Write/Configurations/docker/docker-compose.yml down
            sudo docker image prune -af
            sudo docker compose -f /home/Today-s-Write/Configurations/docker/docker-compose.yml up --build -d

            echo "✅ FastAPI Deployment completed successfully."
          EOF

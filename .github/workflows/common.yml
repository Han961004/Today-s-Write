name: Common Deployment

on:
  workflow_call:
    inputs:
      service:
        description: 'ë°°í¬í•  ì„œë¹„ìŠ¤ ì´ë¦„ (ì˜ˆ: django_app, fast_app)'
        required: true
        type: string
  workflow_dispatch:
    inputs:
      service:
        description: 'ë°°í¬í•  ì„œë¹„ìŠ¤ ì´ë¦„ (ì˜ˆ: django_app, fast_app)'
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH keys
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.AWS_LS_SSH_KEY }}

      - name: Deploy to AWS Lightsail
        env:
          SERVICE: ${{ inputs.service }}
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.AWS_LS_IP }} << 'EOF'
          
          set -e
          echo "ğŸš€ Starting deployment for service: $SERVICE"

          # í”„ë¡œì íŠ¸ ê²½ë¡œ ì„¤ì •
          PROJECT_DIR="/home/Today-s-Write"
          echo "ğŸ“‚ Using project directory: $PROJECT_DIR"

          # 1. ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ ë° Docker ì„¤ì¹˜
          echo "ğŸ”„ Updating system packages..."
          sudo pkill -9 apt || true
          sudo rm -rf /var/lib/apt/lists/lock /var/lib/dpkg/lock /var/lib/dpkg/lock-frontend
          sudo apt update
          sudo apt install -y docker.io curl

          # Docker Compose ì„¤ì¹˜ (ìµœì‹  ë²„ì „)
          echo "ğŸ”„ Installing Docker Compose..."
          sudo mkdir -p /usr/local/lib/docker/cli-plugins
          sudo curl -SL "https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64" \
              -o /usr/local/lib/docker/cli-plugins/docker-compose
          sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
          docker compose version

          # 2. í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ í™•ì¸ ë° ì—…ë°ì´íŠ¸
          echo "ğŸ” Checking project directory..."
          if [ ! -d "$PROJECT_DIR" ]; then
              echo "ğŸ“‚ Creating project directory..."
              sudo mkdir -p "$PROJECT_DIR"
              sudo chown -R ubuntu:ubuntu "$PROJECT_DIR"
              git clone https://github.com/Han961004/Today-s-Write.git "$PROJECT_DIR"
          else
              echo "ğŸ”„ Updating project repository..."
              cd "$PROJECT_DIR"
              git fetch origin main
              git reset --hard origin/main
          fi

          # 3. nginx.conf íŒŒì¼ í™•ì¸
          if [ ! -f "/home/Today-s-Write/Configurations/nginx/nginx.conf" ]; then
              echo "âŒ nginx.conf íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ë°°í¬ ì¤‘ì§€."
              exit 1
          fi
          echo "âœ… nginx.conf íŒŒì¼ í™•ì¸ ì™„ë£Œ."

          # 4. ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì´ë¯¸ì§€ ì •ë¦¬
          echo "ğŸ›‘ Stopping old containers..."
          cd "$PROJECT_DIR"
          sudo docker compose -f Configurations/docker/docker-compose.yml down
          sudo docker image prune -af

          # 5. ìƒˆë¡œìš´ ì„œë¹„ìŠ¤ ë°°í¬
          echo "ğŸš€ Deploying service: $SERVICE"
          sudo docker compose -f Configurations/docker/docker-compose.yml up --build -d --scale django_app=1 --scale fast_app=2

          echo "âœ… Deployment for $SERVICE completed successfully."
          EOF

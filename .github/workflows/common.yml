name: Common Deploy

on:
    workflow_call:
      inputs:
        service:
          description: 'ë°°í¬í•  ì„œë¹„ìŠ¤ ì´ë¦„ (ì˜ˆ: django_app, fast_app)'
          required: true
          type: string
        scale:
          description: 'ì„œë¹„ìŠ¤ ë³µì œë³¸ ìˆ˜'
          required: false
          type: string
          default: "1"  
    workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH keys
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.AWS_LS_SSH_KEY }}

      - name: Deploy common parts to AWS Lightsail
        env:
          SERVICE: ${{ inputs.service }}
          SCALE: ${{ inputs.scale }}
        run: |
            ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.AWS_LS_IP }} << 'EOF'
            echo "ğŸš€ Deploying service: ${{ inputs.service }}"
            echo "ğŸ›  Scale: ${{ inputs.scale }}"

            set -e

            # 1. ê¸°ì¡´ apt í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ë° ë½ íŒŒì¼ ì‚­ì œ
            sudo pkill -9 apt || true
            sudo rm -rf /var/lib/apt/lists/lock /var/lib/dpkg/lock /var/lib/dpkg/lock-frontend

            # 2. Docker ë° Docker Compose ì„¤ì¹˜
            sudo apt update && sudo apt install -y docker.io curl
            sudo mkdir -p /usr/local/lib/docker/cli-plugins
            sudo curl -SL "https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64" \
                -o /usr/local/lib/docker/cli-plugins/docker-compose
            sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
            docker compose version

            # 3. í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì„¤ì • ë° Git ì—…ë°ì´íŠ¸
            PROJECT_DIR="/home/Today-s-Write"
            sudo mkdir -p $PROJECT_DIR
            sudo chown -R ubuntu:ubuntu $PROJECT_DIR
            if [ ! -d $PROJECT_DIR/.git ]; then
                git clone https://github.com/Han961004/Today-s-Write.git $PROJECT_DIR
            else
                cd $PROJECT_DIR
                git fetch origin main
                git reset --hard origin/main
            fi

            # 4. nginx.conf íŒŒì¼ í™•ì¸
            cat /home/Today-s-Write/Configurations/nginx/nginx.conf || { echo "âŒ nginx.conf íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ë°°í¬ ì¤‘ì§€."; exit 1; }

            # 5. ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ë° ì´ë¯¸ì§€ ì •ë¦¬
            cd $PROJECT_DIR
            sudo docker compose -f /home/Today-s-Write/Configurations/docker/docker-compose.yml down
            sudo docker image prune -af

            # 6. ì„œë¹„ìŠ¤ ë°°í¬ (ì„œë¹„ìŠ¤ ì´ë¦„ê³¼ ë³µì œë³¸ ìˆ˜ëŠ” ì¸ìë¡œ ì „ë‹¬)
            sudo docker compose -f /home/Today-s-Write/Configurations/docker/docker-compose.yml up --build -d --scale $SERVICE=$SCALE

            echo "âœ… Deployment for $SERVICE completed successfully."
            EOF
